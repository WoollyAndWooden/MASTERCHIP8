name: Deploy Binaries

on:
  push:
    tags:
      - 'v*.*.*'   # Matches semantic version tags like v1.2.3

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Set version variables
        id: check
        run: |
          TAG="${GITHUB_REF#refs/tags/}"   # extract tag name
          echo "Tag is $TAG"

          # validate semantic version
          if [[ ! $TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "Tag does not match semantic versioning vX.Y.Z"
            echo "deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          MAJOR=${BASH_REMATCH[1]}
          MINOR=${BASH_REMATCH[2]}
          PATCH=${BASH_REMATCH[3]}

          echo "MAJOR=$MAJOR, MINOR=$MINOR, PATCH=$PATCH"
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT
        shell: bash

  deploy-windows:
    needs: check-version
    if: needs.check-version.outputs.deploy == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set reusable strings
        # Turn repeated input strings (such as the build output directory) into step outputs. These step outputs can be used throughout the workflow file.
        id: strings
        shell: bash
        run: |
          echo "build-output-dir=${{ github.workspace }}/build" >> "$GITHUB_OUTPUT"

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Conan
        run: pip install conan

      - name: Detect Conan profile
        run: conan profile detect

      - name: Install dependencies - Windows
        if: runner.os == 'Windows'
        shell: bash
        run: |
          conan install . -s build_type=Release \
          -s compiler.cppstd=20

      - name: Configure CMake - Windows
        if: runner.os == 'Windows'
        # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
        # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
        run: >
          cmake -B ${{ steps.strings.outputs.build-output-dir }}
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }}
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }}
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }}
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.strings.outputs.build-output-dir }}/generators/conan_toolchain.cmake
          -S ${{ github.workspace }}

      - name: Build Windows binary
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release
        shell: bash

      - name: Package Windows binary
        run: |
          mkdir -p artifacts
          cp build/Release/MASTERCHIP8.exe artifacts/
        shell: bash

      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: MASTERCHIP8-windows-${{ needs.check-version.outputs.version }}
          path: artifacts/

  deploy-linux:
    needs: check-version
    if: needs.check-version.outputs.deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies - Linux
        if: runner.os == 'Linux'
        run: |
          conan install . --build=missing -s build_type=Release \
          -s compiler.cppstd=20 \
          -c tools.system.package_manager:mode=install \
          -c tools.system.package_manager:sudo=True \
          -s compiler.cppstd=gnu20

      - name: Configure CMake - Linux
        if: runner.os == 'Linux'
        # Configure CMake in a 'build' subdirectory. `CMAKE_BUILD_TYPE` is only required if you are using a single-configuration generator such as make.
        # See https://cmake.org/cmake/help/latest/variable/CMAKE_BUILD_TYPE.html?highlight=cmake_build_type
        run: |
          cmake -B ${{ steps.strings.outputs.build-output-dir }} \
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_TOOLCHAIN_FILE=${{ steps.strings.outputs.build-output-dir }}/Release/generators/conan_toolchain.cmake \
          -S ${{ github.workspace }}

      - name: Build Linux binary
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --parallel
        shell: bash

      - name: Package Linux binary
        run: |
          mkdir -p artifacts
          cp build/MASTERCHIP8 artifacts/
        shell: bash

      - name: Upload Linux artifact
        uses: actions/upload-artifact@v4
        with:
          name: MASTERCHIP8-linux-${{ needs.check-version.outputs.version }}
          path: artifacts/
