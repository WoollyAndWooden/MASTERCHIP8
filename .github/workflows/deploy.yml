name: Deploy Binaries

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      deploy: ${{ steps.check.outputs.deploy }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - name: Set version variables
        id: check
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          if [[ ! $TAG =~ ^v([0-9]+)\.([0-9]+)\.([0-9]+)$ ]]; then
            echo "deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "deploy=true" >> $GITHUB_OUTPUT
        shell: bash

  deploy-linux:
    needs: check-version
    if: needs.check-version.outputs.deploy == 'true'
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.0'
          host: 'linux'
          target: 'desktop'
          arch: 'gcc_64'
          modules: 'qtmultimedia'

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xinerama0 libxcb-xfixes0 x11-utils libfuse2 imagemagick

      - name: Install Conan
        run: pip install conan

      - name: Install Dependencies (Conan)
        shell: bash
        run: |
          conan profile detect
          conan install . --build=missing -s build_type=Release -s compiler.cppstd=17 \
          -c tools.system.package_manager:mode=install \
          -c tools.system.package_manager:sudo=True

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ github.workspace }}/build/Release/generators;${{ github.workspace }}/build/generators;${{ github.workspace }}"
          cmake --build build --parallel

      - name: Create Desktop File
        run: |
          echo "[Desktop Entry]" > masterchip8.desktop
          echo "Type=Application" >> masterchip8.desktop
          echo "Name=MASTERCHIP8" >> masterchip8.desktop
          echo "Exec=MASTERCHIP8" >> masterchip8.desktop
          echo "Icon=masterchip8" >> masterchip8.desktop
          echo "Categories=Game;" >> masterchip8.desktop
          
          if [ -f resources/masterchip8.png ]; then
            cp resources/masterchip8.png masterchip8.png
          elif [ -f resources/icon.png ]; then
            cp resources/icon.png masterchip8.png
          else
            echo "Icon not found, creating dummy"
            convert -size 256x256 xc:blue masterchip8.png
          fi

      - name: Deploy (AppImage using linuxdeploy)
        run: |
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          
          chmod +x linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-plugin-qt-x86_64.AppImage
          
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps/
          
          cp build/MASTERCHIP8 AppDir/usr/bin/
          cp masterchip8.desktop AppDir/usr/share/applications/
          cp masterchip8.png AppDir/usr/share/icons/hicolor/256x256/apps/masterchip8.png
          
          cp masterchip8.png AppDir/
          
          export QMAKE=$(which qmake)
          
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage
          
          mv MASTERCHIP8*.AppImage MASTERCHIP8-linux.AppImage

      - name: Package Python Lib (Linux)
        run: |
          mkdir python_dist
          find build -name "masterchip8_py*.so" -exec cp {} python_dist/ \;
          cd python_dist
          zip -r ../masterchip8_py-linux.zip .

      - name: Upload Linux Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MASTERCHIP8-linux
          path: |
            MASTERCHIP8-linux.AppImage
            masterchip8_py-linux.zip

  deploy-windows:
    needs: check-version
    if: needs.check-version.outputs.deploy == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.0'
          host: 'windows'
          target: 'desktop'
          arch: 'win64_msvc2019_64'
          modules: 'qtmultimedia'

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Conan
        run: pip install conan

      - name: Install Dependencies (Conan)
        shell: bash
        run: |
          conan profile detect
          conan install . --build=missing -s build_type=Release -s compiler.cppstd=17 \
          -c tools.system.package_manager:mode=install \
          -c tools.system.package_manager:sudo=True

      - name: Generate Icon (Windows)
        shell: bash
        run: |
          if [ -f resources/masterchip8.png ]; then
            magick resources/masterchip8.png resources/icon.ico
          elif [ -f resources/icon.png ]; then
            magick resources/icon.png resources/icon.ico
          else
            magick -size 256x256 xc:blue resources/icon.ico
          fi

      - name: Build
        shell: bash
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_PREFIX_PATH="${{ github.workspace }}/build/Release/generators;${{ github.workspace }}/build/generators;${{ github.workspace }}"
          cmake --build build --config Release

      - name: Deploy (windeployqt)
        shell: bash
        run: |
          mkdir dist
          cp build/Release/MASTERCHIP8.exe dist/
          windeployqt dist/MASTERCHIP8.exe --no-translations --no-system-d3d-compiler
          
          cd dist
          7z a ../MASTERCHIP8-windows.zip .

      - name: Package Python Lib (Windows)
        shell: bash
        run: |
          mkdir python_dist
          find build -name "masterchip8_py*.pyd" -exec cp {} python_dist/ \;
          cd python_dist
          7z a ../masterchip8_py-windows.zip .

      - name: Upload Windows Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: MASTERCHIP8-windows
          path: |
            MASTERCHIP8-windows.zip
            masterchip8_py-windows.zip

  release:
    needs: [deploy-linux, deploy-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Linux Artifacts
        uses: actions/download-artifact@v4
        with:
          name: MASTERCHIP8-linux
          
      - name: Download Windows Artifacts
        uses: actions/download-artifact@v4
        with:
          name: MASTERCHIP8-windows
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            MASTERCHIP8-linux.AppImage
            MASTERCHIP8-windows.zip
            masterchip8_py-linux.zip
            masterchip8_py-windows.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
